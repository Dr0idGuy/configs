
### OS & Terminal Emulator Detection
unamestr=`uname`
if [[ "$unamestr" == 'Linux' ]]; then
  # Get the terminal emulator
  platform='Linux'
  if (( $PPID > 0 )); then
    TERM_PROGRAM=$(ps -f -o comm -p $PPID | tail -1 | sed -r 's;:.*$;;gm' | sed -r 's/[-\/]*$//g')
  else
    # we have no parent process
    # are we in docker?:
    if cat /proc/1/cgroup | grep docker -qa; then
      # yes
      TERM_PROGRAM="docker"
    fi
  fi
elif [[ "$unamestr" == 'Darwin' ]]; then
  # TERM_PROGRAM should already be set
  platform='Darwin'
fi

### Configs install location detection
[ -d $HOME/bin ] && path[1,0]=$HOME/bin
_ZSHRC_SCRIPTPATH="${(%):-%N}"
_ZSHRC_INSTALL_LOC=$(rllink -f "$_ZSHRC_SCRIPTPATH" 2>/dev/null || readlink -f "$_ZSHRC_SCRIPTPATH" 2>/dev/null || perl -MCwd -le 'print Cwd::abs_path(shift)' "$_ZSHRC_SCRIPTPATH")
_ZSHRC_INSTALL_DIR="${_ZSHRC_INSTALL_LOC%/*}"

### VTE Setup (nonlogin shell problem)
if [ $TILIX_ID ] || [ $VTE_VERSION ]; then
  # on Ubuntu it's in vte-2.91.sh sometimes for whatever reason?
  if [[ -s '/etc/profile.d/vte.sh' ]]; then
    Z_VTE_CONF_SETUP_FILE='/etc/profile.d/vte.sh'
  elif [[ -s '/etc/profile.d/vte-2.91.sh' ]]; then
    Z_VTE_CONF_SETUP_FILE='/etc/profile.d/vte-2.91.sh'
  fi

  if [[ -n "$Z_VTE_CONF_SETUP_FILE" ]]; then
    source $Z_VTE_CONF_SETUP_FILE
  fi
fi

### ZSH Theme selection
# Powerline available theme
Z_DEFAULT_POWERLINE_THEME="agnoster"
# Powerline theme only activated if it's installed
Z_INSTALL_DETECT_POWERLINE_THEME="bhilburn/powerlevel9k"
case "$TERM_PROGRAM" in
  'python2'|\
  'terminator'|\
  'iTerm.app'|\
  'gnome-terminal'|\
  'tmux'|\
  'tilix'|\
  'sshd')
    ZSH_THEME="$Z_DEFAULT_POWERLINE_THEME"
    ;;
  'login')
    ZSH_THEME="fishy"
    ;;
  'zsh'|*)
    # Try to keep the same theme if it's already set.
    if [[ -z "$ZSH_THEME" ]]; then
      ZSH_THEME="fishy"
    fi
    ;;
esac
export ZSH_THEME

ENABLE_CORRECTION="true"
COMPLETION_WAITING_DOTS="true"

if [[ "${Z_LSBASE}" == "" ]]; then
  # used for a few plunks
  export Z_LSBASE='ls'
  if [[ "$platform" == "Linux" ]]; then
    export Z_LSARGEXTRA='--color=tty'
    export Z_LSARG_FORCE_COLOR='--color=always'
  elif [[ "$platform" == "Darwin" ]]; then
    export Z_LSARGEXTRA='-G'
  fi
fi

### Load extra completions
[ -d "$_ZSHRC_INSTALL_DIR/fpath" ] && fpath+=("$_ZSHRC_INSTALL_DIR/fpath")

### PLUGINS
antigenplugins=(
  # vi-mode
  # colored-man-pages
  # peterhurford/git-it-on.zsh
  git
  git-flow
  command-not-found
  robobenklein/k
  z
  Tarrasch/zsh-bd
  zsh-users/zsh-completions
  zdharma/fast-syntax-highlighting
  # zsh-users/zsh-syntax-highlighting
)
typeset -U antigenplugins
plunks=( # PLugin chUNKS
  lca # last command arguments
  lslbntl # ls long, but not too long
  presenter-mode # zsh for presenting to groups
  git-lfs-completion
)
typeset -U plunks

### User configuration

# the background color for the terminal emulator
TERM_EMULATOR_BG_DEFAULT="#444444"

# Tmux plugin:
ZSH_TMUX_FIXTERM_WITHOUT_256COLOR="screen-256color"
ZSH_TMUX_AUTOSTART="false"
ZSH_TMUX_AUTOCONNECT="false"

[[ -s $HOME/.pythonz/etc/bashrc ]] && source $HOME/.pythonz/etc/bashrc

# Go environment
[ -d $HOME/code/go ] && export GOPATH=$HOME/code/go
[ -d $HOME/code/go/bin ] && path+=($HOME/code/go/bin)

# NVM nodejs
if [ -d $HOME/.nvm ]; then
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
  [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
fi

# added by travis gem
[ -f $HOME/.travis/travis.sh ] && source $HOME/.travis/travis.sh

# Fix that guake doesn't set TERM properly
# it actually does have 256color...
if [[ $TERM_PROGRAM == "python2" ]] && [[ $TERM == "xterm" ]]; then
  TERM=xterm-256color
fi

### Load framework

# Check that antigen is installed
if [[ -s $HOME/.antigen/antigen.zsh ]]; then
  # If powerlevel9k is installed, use it
  if [[ -d ~/.antigen/bundles/$Z_INSTALL_DETECT_POWERLINE_THEME ]] && \
    [[ $ZSH_THEME == $Z_DEFAULT_POWERLINE_THEME ]] || \
    [[ $ZSH_THEME == $Z_INSTALL_DETECT_POWERLINE_THEME ]]; then
    # More power
    ZSH_THEME="$Z_INSTALL_DETECT_POWERLINE_THEME"
    POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(context root_indicator dir_writable dir vcs)
    POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(status command_execution_time background_jobs battery time)
    # Vim master race?
    #POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS+=( vi_mode )
    POWERLEVEL9K_VI_INSERT_MODE_STRING="I"
    POWERLEVEL9K_VI_COMMAND_MODE_STRING="CMD"
    # Specifics
    POWERLEVEL9K_BATTERY_LOW_THRESHOLD=30
    POWERLEVEL9K_COMMAND_EXECUTION_TIME_THRESHOLD=1
    POWERLEVEL9K_CONTEXT_DEFAULT_FOREGROUND="white"
    POWERLEVEL9K_BATTERY_ICON=""
    POWERLEVEL9K_SHORTEN_DIR_LENGTH=1
    POWERLEVEL9K_SHORTEN_DELIMITER=""
    POWERLEVEL9K_SHORTEN_STRATEGY="truncate_from_right"
    POWERLEVEL9K_COMMAND_EXECUTION_TIME_BACKGROUND="black"
    POWERLEVEL9K_COMMAND_EXECUTION_TIME_FOREGROUND="242" # dimm gray
    POWERLEVEL9K_EXECUTION_TIME_ICON="⧖ "
    POWERLEVEL9K_VCS_REMOTE_BRANCH_ICON="⇗ "
    if command -v rtab > /dev/null 2>&1; then
      POWERLEVEL9K_CUSTOM_RTAB_DIR="echo \$(rtab -t -l)"
      POWERLEVEL9K_CUSTOM_RTAB_DIR_FOREGROUND="black"
      POWERLEVEL9K_CUSTOM_RTAB_DIR_BACKGROUND="blue"
      POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(context root_indicator dir_writable custom_rtab_dir vcs)
    fi
  fi
  ANTIGEN_CACHE=$HOME/.antigen/init-cache-${TERM_PROGRAM}-$( echo $ZSH_THEME | tr -cd '[[:alnum:]]').zsh
  source $HOME/.antigen/antigen.zsh
  antigen use oh-my-zsh
  for plugin in $antigenplugins; do
    antigen bundle "$plugin"
  done
  antigen theme $ZSH_THEME
  antigen apply
  # Remove paths that start with $HOME/.antigen/
  if [[ "$platform" == 'Linux' ]]; then
    antigen_fullpath=$(readlink -f $HOME/.antigen/ )
  elif [[ "$platform" == 'Darwin' ]]; then
    antigen_fullpath=$(readlink $HOME/.antigen/ )
  fi
  path=( ${path%${antigen_fullpath}/*} )
else
  # Where did antigen go?
  echo -e "\033[0;31mZSHRC: Couldn't find ~/.antigen/antigen.zsh!\033[0m"
  # Do we have OMZ?
  if [[ -s $HOME/.oh-my-zsh/oh-my-zsh.sh ]]; then
    export ZSH=$HOME/.oh-my-zsh
    source $ZSH/oh-my-zsh.sh
  fi
fi

# You may need to manually set your language environment
#export LANG=en_US.UTF-8

### Load Plunks
# little bits of plugins that I plop down
# PLugin chUNKS
for plunk in "${plunks[@]}"; do
  source $_ZSHRC_INSTALL_DIR/plunks/${plunk}.zsh
done

# compinit

### Functions

# function which properly sets up vi mode things in order
function zsh_start_vi_mode() {
  export KEYTIMEOUT=1
  antigen bundle vi-mode
  #bindkey -v
  POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS+=( vi_mode )
  # in vi command mode:
  bindkey -M vicmd '?' history-incremental-search-backward
  bindkey -M vicmd '/' history-incremental-search-forward
  bindkey -M vicmd "k" up-line-or-beginning-search
  bindkey -M vicmd "j" down-line-or-beginning-search
  bindkey -M vicmd "^V" edit-command-line
  # Up/down as history partial search
  bindkey "^[OA" up-line-or-beginning-search
  bindkey "^[OB" down-line-or-beginning-search
}

### Personal shortcuts and aliases

alias zvi=zsh_start_vi_mode

if command -v exa > /dev/null 2>&1; then
  export Z_LSBASE='exa'
  export Z_LSARGEXTRA='--git'
  export Z_LSARG_FORCE_COLOR='--color=always'
fi

# Editor
if command -v nvim > /dev/null 2>&1; then
  export EDITOR='nvim'
elif command -v vim > /dev/null 2>&1; then
  export EDITOR='vim'
elif command -v vi > /dev/null 2>&1; then
  export EDITOR='vi'
elif command -v nano > /dev/null 2>&1; then
  export EDITOR='nano'
fi
alias v="$EDITOR"

# ls shortcuts

alias l="lslbntl" # from the plunk
alias ll="$Z_LSBASE $Z_LSARGEXTRA -lh"
alias la="$Z_LSBASE $Z_LSARGEXTRA -lah"

if command -v d > /dev/null 2>&1; then
  unalias d >/dev/null 2>&1
fi
function d () {
  if [[ -n $1 ]]; then
    dirs "$@"
  else
    dirs -v | head -10
  fi
}
compdef _dirs d

function cprp () {
  rsync -r --info=progress2 --delay-updates --partial-dir=.rsync-partial "$@"
}
compdef _rsync cprp

alias gpg-message="gpg2 -a -es -r"
alias gpg-sign="gpg2 -a -s"
if command -v atom > /dev/null 2>&1; then
  alias a="atom"
fi
if command -v nautilus > /dev/null 2>&1; then
  alias n="nautilus"
fi
if command -v git-lfs > /dev/null 2>&1; then
  alias glfs="git-lfs"
fi
if command -v bfg.jar > /dev/null 2>&1 && command -v java > /dev/null 2>&1; then
  alias bfg="java -jar $(which bfg.jar )"
fi
alias m="make"
alias c="cat"
alias pu="pushd"
alias po="popd"

# CD Git root
alias cdg='cd $(git rev-parse --show-toplevel)'
# normalized git branch name ('/' -> '_')
function git_branch_norm() {
  git symbolic-ref HEAD|cut -d'/' -f3-|sed -e 's;/;_;'
}

### PATH configuration

# Keep this clean!
typeset -U path # unique items only in path array

# Add .local/bin to path with priority,
[ -d "$HOME/.local/bin" ] && path[1,0]="$HOME/.local/bin"

# Place home bin at front of path
[ -d "$HOME/bin" ] && path[1,0]="$HOME/bin"

export PATH

# EOF
ZSHRC_LOADED=1
